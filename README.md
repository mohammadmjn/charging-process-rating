# Charging Process Rating API

This project implements a small RESTful API for applying a given rate to a CDR (charge detail record).

## Prerequisites

To run the API, you just need to install [Python 3](https://www.python.org/downloads/). Python 3.9 has beed used to develop the API.

## Setup Virtual Environment

It is better to create a virtual environment before installing Python packages. You can create one using following command in the root of the project:

```bash
python -m venv venv
source venv/bin/activate
```

## Setup

Install project dependancies:

```bash
make setup
```

## Run Locally

To run the API on your local system, use the following command:

```bash
make serve
```

This will bring up the API on http://127.0.0.1:5000 address. We have just one endpoint in this web service:

- /rate

This endpoint accepts a `POST` request, and will response with `200` status code if everything goes well. It will return the resulting overall amount as `overall` and the component prices within `components` field.

## Run the Tests

To run the tests, use the following command:

```bash
make test
```

## Deploy on Docker

Given you have already installed Docker on your system, you can use the following command in the terminal in order to deploy the project on docker:

```bash
make deploy
```

Note 1: Before executing the above command, please change the `{your-dockerhub-username}` to your preferred docker hub username.

Note 2: The `gunicorn` package has been included in `requirements.txt` as a dependency of the API just to be able to deploy and run API on Docker or cloud environments.

## Logs

The logs generated by werkzeug are stored in `runtime.log` as well as showing them in console. It has been done through configuring python logging package. You can retrieve the runtime log of the Flask app in `runtime.log`. The maximum length for the current log file has been set to `5 * 2 ^ 20 = 5242880 Bytes = 5MB`. Also, the threshold for number of backups for log files has been set to `9` which means whenever the current log file is nearly `maxBytes` in length, rollover occurs. So, the system will successively create new files with the same pathname as the base file, but with extensions ".1", ".2", and etc.

## Test the API

You can test the API with a `POST` request whose body should be a JSON like below:

```json
{
  "rate": {
    "energy": 0.3,
    "time": 2,
    "transaction": 1
  },
  "cdr": {
    "meterStart": 1204307,
    "timestampStart": "2021-04-05T10:04:00Z",
    "meterStop": 1215230,
    "timestampStop": "2021-04-05T11:27:00Z"
  }
}
```

`timestampStart` and `timestampStop` must in ISO 8601 date time format.

A sample successful response from the API:

```json
{
  "overall": 7.04,
  "components": {
    "energy": 3.277,
    "time": 2.767,
    "transaction": 1
  }
}
```

## License

Distributed under the MIT License. See `LICENSE` file for more information.
